syntax = "proto3";

package pb;

option go_package = "/cpe-box/pb";

enum CommandType {
  UNKNOWN = 0;
  RESTART = 1;
  RUN_SHELL = 2;
  UPLOAD_FILE = 3;
  START_PORT_FORWARD = 4;
  STOP_PORT_FORWARD = 5;
}

enum AgentType {
  AGENT_TYPE_UNKNOWN = 0;
  AGENT_TYPE_CPE = 1;
}

message PortForward {
  string req_id = 1;
  string proto = 2;         // tcp
  string target_addr = 3;   // agent target address 127.0.0.1:9000
}

message Register {
  string id = 1;
  string token = 2;
  string version = 3;
  AgentType agent_type = 4;
}

message Heartbeat {
  string id = 1;
  uint64 ts = 2;
}

message Message {
  string from = 1;
  string body = 2;
}

message Command {
  CommandType type = 1;
  string target_id = 2;
  string payload = 3; // JSON or simple string (e.g. command or filename)
}

message CommandResult {
  string target_id = 1;
  bool ok = 2;
  string output = 3;
  string req_id = 4; 
}

message FileChunk {
  string transfer_id = 1;
  bytes chunk = 2;
  bool last = 3;
  string filename = 4;

  int64 total_size = 5;
  string sha256 = 6;

  int64 offset = 7;
}

message FileResume {
  string transfer_id = 1;
  int64 received = 2;
}

message Envelope {
  oneof payload {
    Register register = 1;
    Heartbeat heartbeat = 2;
    Message message = 3;
    Command command = 4;
    CommandResult result = 5;
    FileChunk file_chunk = 6;
    PortForward port_forward = 7;
    FileResume file_resume = 8;
  }
}
